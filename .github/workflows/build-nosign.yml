name: Build (No Sign)

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build (comma-separated: mac,win,linux or all)'
        required: true
        default: 'mac,win'
        type: choice
        options:
          - mac,win
          - mac
          - win
          - linux
          - all
  push:
    tags:
      - 'build-nosign-*'

permissions:
  contents: 'read'

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            platform: mac
          - os: windows-latest
            platform: win
          - os: ubuntu-22.04
            platform: linux

    steps:
      # 检查是否应该运行此平台的构建
      - name: Check if platform should be built
        id: check_platform
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PLATFORMS="${{ github.event.inputs.platforms }}"
            if [ "$PLATFORMS" == "all" ] || [[ "$PLATFORMS" == *"${{ matrix.platform }}"* ]]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/build-nosign-* ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup
        if: steps.check_platform.outputs.should_build == 'true'
        shell: bash
        run: |
          git config --global url."https://${{secrets.USER}}:${{secrets.TOKEN}}@github.com/".insteadOf "https://github.com/" || true
          git config --global url."https://${{secrets.USER}}:${{secrets.TOKEN}}@api.github.com/".insteadOf "https://api.github.com/" || true

      - name: Install Go
        if: steps.check_platform.outputs.should_build == 'true'
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
          check-latest: true

      - name: Setup GO
        if: steps.check_platform.outputs.should_build == 'true'
        shell: bash
        run: |
          go version
          echo GOPATH=$(go env GOPATH) >> $GITHUB_ENV
          echo GOBIN=$(go env GOPATH)/bin >> $GITHUB_ENV
          echo $(go env GOPATH)/bin >> $GITHUB_PATH

      - name: Set up Python
        if: steps.check_platform.outputs.should_build == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install LibSecret
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsecret-1-dev jq

      - name: Setup .NET 9
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'windows-latest'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Check out Git repository
        if: steps.check_platform.outputs.should_build == 'true'
        uses: actions/checkout@v4

      - name: Install Node.js
        if: steps.check_platform.outputs.should_build == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 25.2.1

      - name: Install dependencies
        if: steps.check_platform.outputs.should_build == 'true'
        run: npm ci --legacy-peer-deps

      - name: Install Webpack
        if: steps.check_platform.outputs.should_build == 'true'
        run: npm install --save-dev webpack-cli --legacy-peer-deps

      - name: Update locale
        if: steps.check_platform.outputs.should_build == 'true'
        run: npm run update:locale
        env:
          GITHUB_TOKEN: ${{secrets.TOKEN}}

      - name: Update Addon only AMD (Windows)
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'windows-latest'
        shell: bash
        run: |
          ./update-ci.sh --user="${{secrets.USER}}" --token="${{secrets.TOKEN}}" --os="${{matrix.os}}" --middleware-version="$( cat middleware.version )" || echo "Middleware update skipped"

      - name: Update Addon AMD and ARM (Mac/Linux)
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os != 'windows-latest'
        shell: bash
        run: |
          ./update-ci.sh --user="${{secrets.USER}}" --token="${{secrets.TOKEN}}" --os="${{matrix.os}}" --middleware-version="$( cat middleware.version )" --arch="arm" || echo "ARM middleware update skipped"
          ./update-ci.sh --user="${{secrets.USER}}" --token="${{secrets.TOKEN}}" --os="${{matrix.os}}" --middleware-version="$( cat middleware.version )" --arch="amd" || echo "AMD middleware update skipped"

      - name: Build Native Messaging Host Windows
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'windows-latest'
        run: npm run build:nmh-win
        env:
          CGO_ENABLED: 0

      - name: Build Native Messaging Host
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os != 'windows-latest'
        run: npm run build:nmh
        env:
          CGO_ENABLED: 0

      - name: Build Frontend (Mac)
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'macos-15'
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{secrets.TOKEN}}
          release: false
          args: --arm64 --x64
        env:
          DEBUG: electron-builder
          USE_HARD_LINKS: false
          # 跳过签名和公证
          ELECTRON_SKIP_NOTARIZE: 'true'
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          # 跳过 Sentry
          ELECTRON_SKIP_SENTRY: 'true'

      - name: Build Frontend (Windows)
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'windows-latest'
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{secrets.TOKEN}}
          release: false
          args: -c.win.sign=null
        env:
          DEBUG: electron-builder
          USE_HARD_LINKS: false
          # 跳过签名
          ELECTRON_SKIP_NOTARIZE: 'true'
          # 跳过 Sentry
          ELECTRON_SKIP_SENTRY: 'true'

      - name: Build Frontend (Linux)
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'ubuntu-22.04'
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{secrets.TOKEN}}
          release: false
          args: --arm64 --x64
        env:
          DEBUG: electron-builder
          USE_HARD_LINKS: false
          # 跳过 Sentry
          ELECTRON_SKIP_SENTRY: 'true'

      - name: Make artifacts dir
        if: steps.check_platform.outputs.should_build == 'true'
        shell: bash
        run: |
          mkdir -p artifacts

      - name: Collect artifacts (Mac)
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'macos-15'
        run: |
          mv dist/*.{dmg,zip} artifacts/ 2>/dev/null || true
          echo "Mac artifacts collected"

      - name: Collect artifacts (Windows)
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Remove-Item dist/anytypeHelper.exe -ErrorAction SilentlyContinue
          Remove-Item dist/nativeMessagingHost.exe -ErrorAction SilentlyContinue
          Move-Item dist/*.exe artifacts/ -ErrorAction SilentlyContinue
          Write-Host "Windows artifacts collected"

      - name: Collect artifacts (Linux)
        if: steps.check_platform.outputs.should_build == 'true' && matrix.os == 'ubuntu-22.04'
        run: |
          mv dist/*.{AppImage,deb,rpm,tar.gz,zip} artifacts/ 2>/dev/null || true
          echo "Linux artifacts collected"

      - name: Upload artifacts
        if: steps.check_platform.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-artifacts
          path: artifacts/
          retention-days: 7

      - name: List artifacts
        if: steps.check_platform.outputs.should_build == 'true'
        shell: bash
        run: |
          echo "=== Artifacts in artifacts/ ==="
          ls -lah artifacts/ 2>/dev/null || dir artifacts/ || echo "No artifacts found"

